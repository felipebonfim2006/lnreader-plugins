var e=this&&this.__awaiter||function(e,t,a,n){return new(a||(a=Promise))((function(r,o){function l(e){try{s(n.next(e))}catch(e){o(e)}}function i(e){try{s(n.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(l,i)}s((n=n.apply(e,t||[])).next())}))},t=this&&this.__generator||function(e,t){var a,n,r,o,l={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function i(i){return function(s){return function(i){if(a)throw new TypeError("Generator is already executing.");for(;o&&(o=0,i[0]&&(l=0)),l;)try{if(a=1,n&&(r=2&i[0]?n.return:i[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,i[1])).done)return r;switch(n=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return l.label++,{value:i[1],done:!1};case 5:l.label++,n=i[1],i=[0];continue;case 7:i=l.ops.pop(),l.trys.pop();continue;default:if(!(r=l.trys,(r=r.length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){l=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){l.label=i[1];break}if(6===i[0]&&l.label<r[1]){l.label=r[1],r=i;break}if(r&&l.label<r[2]){l.label=r[2],l.ops.push(i);break}r[2]&&l.ops.pop(),l.trys.pop();continue}i=t.call(e,l)}catch(e){i=[6,e],n=0}finally{a=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}};Object.defineProperty(exports,"__esModule",{value:!0});var a=require("htmlparser2"),n=require("@libs/fetch"),r=require("@libs/filterInputs"),o=require("@libs/novelStatus"),l=function(){function l(){this.id="royalroad",this.name="Royal Road",this.version="2.0.0",this.icon="src/en/royalroad/icon.png",this.site="https://www.royalroad.com/",this.filters={order:{value:"weekly-popular",label:"Order By",options:[{label:"Best Rated",value:"best-rated"},{label:"Trending",value:"trending"},{label:"Ongoing Fictions",value:"active-popular"},{label:"Complete",value:"complete"},{label:"Popular this week",value:"weekly-popular"},{label:"Latest Updates",value:"latest-updates"},{label:"Newest Fictions",value:"new"},{label:"Rising Stars",value:"rising-stars"},{label:"Writathon",value:"writathon"}],type:r.FilterTypes.Picker},genre:{value:"",label:"Genres",options:[{label:"ALL",value:""},{label:"Action",value:"action"},{label:"Adventure",value:"adventure"},{label:"Comedy",value:"comedy"},{label:"Contemporary",value:"contemporary"},{label:"Drama",value:"drama"},{label:"Fantasy",value:"fantasy"},{label:"Historical",value:"historical"},{label:"Horror",value:"horror"},{label:"Mystery",value:"mystery"},{label:"Psychological",value:"psychological"},{label:"Romance",value:"romance"},{label:"Satire",value:"satire"},{label:"Sci-fi",value:"sci_fi"},{label:"Short Story",value:"one_shot"},{label:"Tragedy",value:"tragedy"}],type:r.FilterTypes.Picker}}}return l.prototype.parseNovels=function(e){var t=[],n={name:""},r=!1,o=!1,l=new a.Parser({onopentag:function(e,a){var l,i;(null===(l=a.class)||void 0===l?void 0:l.includes("fiction-list-item"))&&(r=!0),r&&("a"===e&&(null===(i=a.class)||void 0===i?void 0:i.includes("bold"))&&(n.path=a.href.slice(1),o=!0),"img"===e&&(n.cover=a.src),n.path&&n.name&&(t.push(n),(n={}).name=""))},ontext:function(e){o&&(n.name+=e)},onclosetag:function(e){"h2"===e&&(o=!1,r=!1)}});return l.write(e),l.end(),t},l.prototype.popularNovels=function(a,r){return e(this,arguments,void 0,(function(e,a){var r,o,l=a.filters;return t(this,(function(t){switch(t.label){case 0:return r="".concat(this.site,"fictions/"),r+=l.order.value,r+="?page=".concat(e),""!==l.genre.value&&(r+="&genre=".concat(l.genre.value)),[4,(0,n.fetchApi)(r).then((function(e){return e.text()}))];case 1:return o=t.sent(),[2,this.parseNovels(o)]}}))}))},l.prototype.parseNovel=function(r){return e(this,void 0,void 0,(function(){var e,l,i,s,u,c,p,v,d,h,f,b,y,m,w,g,N;return t(this,(function(t){switch(t.label){case 0:return[4,(0,n.fetchApi)(this.site+r)];case 1:return[4,t.sent().text()];case 2:switch(e=t.sent(),l={path:r,name:"",summary:"",chapters:[]},i=!1,s=!1,u=!1,c=!1,p=0,v=!1,d=!1,h=[],f=!1,b=!1,y=[],m=[],w=new a.Parser({onopentag:function(e,t){var a,n,r;"img"===e&&(null===(a=t.class)||void 0===a?void 0:a.includes("thumbnail"))&&(l.cover=t.src),"span"===e&&(null===(n=t.class)||void 0===n?void 0:n.includes("label-sm"))&&p++,"span"===e&&(null===(r=t.class)||void 0===r?void 0:r.includes("tags"))&&(v=!0)},onopentagname:function(e){"h1"===e&&(i=!0),c&&"a"===e&&(s=!0),v&&"a"===e&&(d=!0),"label"===e&&(u=!1,v=!1),f&&"script"===e&&(b=!0)},onattribute:function(e,t){"class"===e&&"description"===t&&(u=!0),"class"===e&&"page-footer footer"===t&&(f=!0)},ontext:function(e){i&&(l.name=e),s&&(l.author=e,s=!1),u&&(l.summary+=e),2===p&&(l.status=e.trim(),p++),d&&h.push(e),b&&e.includes("window.chapters =")&&(y=JSON.parse(e.match(/window.chapters = (.+])(?=;)/)[1]),m=JSON.parse(e.match(/window.volumes = (.+])(?=;)/)[1]))},onclosetag:function(e){"h1"===e&&(i=!1,c=!0),"h4"===e&&(c=!1),"a"===e&&(d=!1),"script"===e&&(b=!1),"body"===e&&(f=!1)}}),w.write(e),w.end(),l.summary=null===(N=l.summary)||void 0===N?void 0:N.trim(),l.genres=h.join(", "),l.status){case"ONGOING":l.status=o.NovelStatus.Ongoing;break;case"HIATUS":l.status=o.NovelStatus.OnHiatus;break;case"COMPLETED":l.status=o.NovelStatus.Completed;break;default:l.status=o.NovelStatus.Unknown}return g=y.map((function(e){var t=m.find((function(t){return t.id===e.volumeId}));return{name:e.title,path:e.url.slice(1),releaseTime:e.date,chapterNumber:null==e?void 0:e.order,page:null==t?void 0:t.title}})),l.chapters=g,[2,l]}}))}))},l.prototype.parseChapter=function(r){return e(this,void 0,void 0,(function(){var e,o,l,i,s,u,c,p;return t(this,(function(t){switch(t.label){case 0:return[4,(0,n.fetchApi)(this.site+r)];case 1:return[4,t.sent().text()];case 2:return e=t.sent(),o="",l=!1,i=!1,s=!1,u=!1,c="",(p=new a.Parser({onopentag:function(e,t){if(l&&"div"===e){var a=t.style;a?(o+='<div style="'.concat(a,'">'),u=!0):o+="<div>"}if(l&&"table"===e){var n=t.width;o+=n?'<table width="'.concat(n,'">'):"<table>"}if(l&&"tbody"===e&&(o+="<tbody>"),l&&"tr"===e&&(o+="<tr>"),l&&"td"===e){var r=t.width;o+=r?'<td width="'.concat(r,'">'):"<td>"}},onattribute:function(e,t){"class"===e&&"chapter-inner chapter-content"===t&&(l=!0),"class"===e&&"portlet light t-center-3"===t&&(l=!1,i=!1),"class"===e&&t===c&&(i=!1)},onopentagname:function(e){l&&"p"===e&&(o+="<p>",i=!0,u&&(u=!1)),"style"===e&&(s=!0),l&&"br"===e&&(o+="<br>")},ontext:function(e){i&&(o+=e),u&&(o+=e),s&&e.includes("display: none;")&&(c=e.match(/\.(.*)\{/)[1])},onclosetag:function(e){"p"===e&&(i=!1,o+="</p>"),"style"===e&&(s=!1),l&&"td"===e&&(o+="</td>"),l&&"tr"===e&&(o+="</tr>"),l&&"tbody"===e&&(o+="</tbody>"),l&&"table"===e&&(o+="</table>"),l&&"div"===e&&(u=!1,o+="</div>")}})).write(e),p.end(),[2,o]}}))}))},l.prototype.searchNovels=function(a,r){return e(this,void 0,void 0,(function(){var e,o;return t(this,(function(t){switch(t.label){case 0:return e="".concat(this.site,"fictions/search?page=").concat(r,"&title=").concat(a),[4,(0,n.fetchApi)(e).then((function(e){return e.text()}))];case 1:return o=t.sent(),[2,this.parseNovels(o)]}}))}))},l}();exports.default=new l;